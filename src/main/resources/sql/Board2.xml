<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="board2">
	
	<select id="selectBoard2List" resultType="com.board.test2.BoardVO" parameterType="com.board.test.common.SearchVO">
        SELECT BRDNO
              ,BRDTITLE
              ,BRDWRITER
              ,DATE_FORMAT(BRDDATE,'%Y-%m-%d') BRDDATE 
              ,BRDHIT
        	  ,(SELECT COUNT(*)
        	      FROM TBL_BOARDFILE
        	     WHERE BRDNO = T.BRDNO   
        	   ) FILECNT
        	  ,(SELECT COUNT(*) 
        	      FROM TBL_BOARDREPLY 
        	     WHERE BRDNO=T.BRDNO 
        	       AND REDELETEFLAG='N') REPLYCNT
          FROM TBL_BOARD2 T
    <include refid="includeBoard"/>
         ORDER BY BRDNO DESC
         LIMIT ${rowStart-1}, 10
    </select> 
    
    <select id="selectBoard2One" parameterType="String" resultType="com.board.test2.BoardVO">
        SELECT BRDNO
              ,BRDTITLE
              ,BRDWRITER
              ,BRDMEMO
              ,DATE_FORMAT(BRDDATE,'%Y-%m-%d') BRDDATE
          FROM TBL_BOARD2
         WHERE BRDNO=#{brdNo}
           AND BRDDELETEFLAG = 'N'
    </select>
    
    <select id="selectBoardFileList" resultType="com.board.test.common.FileVO" parameterType="String">
    	SELECT FILENO
    	      ,FILENAME
    	      ,REALNAME
    	      ,FILESIZE
          FROM TBL_BOARDFILE
         WHERE BRDNO=#{brdNo}
         ORDER BY FILENO DESC 
    </select>
    
	<select id="selectBoard2Count" resultType="Integer" parameterType="com.board.test.common.SearchVO">
	    SELECT COUNT(*)
	      FROM TBL_BOARD2
	    <include refid="includeBoard"/>
	</select>
	
	<select id="selectBoardReplyList" resultType="com.board.test2.BoardReplyVO">
		SELECT BRDNO
			  ,RENO
			  ,REWRITER
			  ,REDELETEFLAG
			  ,REMEMO
			  ,REDATE 
			  ,REPARENT
			  ,REDEPTH
			  ,REORDER
          FROM TBL_BOARDREPLY
         WHERE BRDNO=#{brdNo} 
           AND REDELETEFLAG='N'
         ORDER BY RENO
	</select>
	
	<select id="selectBoardReplyParent" resultType="com.board.test2.BoardReplyVO" parameterType="String">
		SELECT BRDNO
			  ,REDEPTH+1 REDEPTH
			  ,REORDER
		  FROM TBL_BOARDREPLY
		 WHERE RENO = #{reParent}
	</select>
	
	<select id="selectBoardReplyChild" resultType="Integer" parameterType="String">
		SELECT COUNT(*)
		  FROM TBL_BOARDREPLY
		 WHERE REPARENT=#{reParent}
		   AND RENO != #{reParent}
		   AND REDELETEFLAG = 'N'
	</select>
	
	<select id="selectBoardReplyMaxOrder" resultType="Integer" parameterType="String">
		SELECT IFNULL(MAX(REORDER),0)+1
		  FROM TBL_BOARDREPLY
		 WHERE BRDNO = #{brdNo}
	</select>
	<update id="updateBoardReplyOrder" parameterType="com.board.test2.BoardReplyVO">
		UPDATE TBL_BOARDREPLY
		   SET REORDER = REORDER + 1
		 WHERE BRDNO = #{brdNo} AND REORDER > #{reOrder} 
	</update>
	
	<insert id="insertBoard2" parameterType="com.board.test2.BoardVO" >
		<selectKey resultType="String" keyProperty="brdNo" order="BEFORE">
			SELECT IFNULL(MAX(BRDNO),0)+1
			  FROM TBL_BOARD2
		</selectKey>
        INSERT INTO TBL_BOARD2(BRDNO,BRDTITLE, BRDWRITER, BRDMEMO, BRDDATE, BRDHIT, BRDDELETEFLAG)
        VALUES (#{brdNo},#{brdTitle}, #{brdWriter}, #{brdMemo}, NOW(),0,'N')
	</insert>
	
	<insert id="insertBoard2File" parameterType="com.board.test.common.FileVO">
		INSERT INTO TBL_BOARDFILE (BRDNO, FILENAME, REALNAME, FILESIZE)
        VALUES (#{parentPK}, #{fileName}, #{realName}, #{fileSize})
	</insert>
	
	<update id="updateBoard2" parameterType="com.board.test2.BoardVO">
        UPDATE TBL_BOARD2
           SET BRDTITLE=#{brdTitle}
             , BRDWRITER=#{brdWriter}
             , BRDMEMO=#{brdMemo}
         WHERE BRDNO=#{brdNo}
           AND BRDDELETEFLAG = 'N'
    </update> 
		
    <update id="updateBoard2Read" parameterType="String">
    	UPDATE TBL_BOARD2
    	   SET BRDHIT = BRDHIT + 1
    	 WHERE BRDNO = #{brdNo}
    </update> 
    
    <update id="updateBoardReply" parameterType="com.board.test2.BoardReplyVO">
    	UPDATE TBL_BOARDREPLY
    	   SET REMEMO =#{reMemo}
    	 WHERE RENO = #{reNo}
    </update>
    
    <update id="updateBoardReplyOrderDelete" parameterType="com.board.test2.BoardReplyVO">
    	UPDATE TBL_BOARDREPLY T1
    	 INNER JOIN TBL_BOARDREPLY T2 ON T2.BRDNO=T1.BRDNO AND T1.REORDER >T2.REORDER AND T1.REDELETEFLAG='N'
    	  SET T1.REORDER = T1.REORDER -1
    	 WHERE T2.RENO = #{reNo}
    </update>
	
	<delete id="deleteBoard2One" parameterType="String">
        UPDATE TBL_BOARD2 
           SET BRDDELETEFLAG = 'Y'
         WHERE BRDNO=#{brdNo}
    </delete> 
    
    <delete id="deleteBoard2File" parameterType="HashMap">
    	DELETE
    	  FROM TBL_BOARDFILE
    	 WHERE FILENO IN(
    	 					<foreach item="item" index="index" collection="fileNo" separator=",">
    	 						${item}
    	 					</foreach>
    	 				)
    </delete>
    
    <delete id="deleteBoardReply" parameterType="String">
    	UPDATE TBL_BOARDREPLY
    	   SET REDELETEFLAG = 'Y'
    	 WHERE RENO = #{reNo}
    </delete>
    
    <insert id="insertBoardReply" parameterType="com.board.test2.BoardReplyVO">
    	<selectKey resultType="String" keyProperty="reNo" order="BEFORE">
    		SELECT IFNULL(MAX(RENO),0)+1
    		  FROM TBL_BOARDREPLY
    	</selectKey>
    	INSERT INTO TBL_BOARDREPLY(BRDNO,RENO,REWRITER,REDELETEFLAG,REMEMO,REDATE,REORDER,REPARENT,REDEPTH)
    				VALUES(#{brdNo},#{reNo},#{reWriter},'N',#{reMemo},NOW(),#{reOrder},
    				<choose>
    					<when test="reParent == null">#{reNo},0</when>
    					<otherwise>#{reParent},#{reDepth}</otherwise>
    				</choose>
    				)
    </insert>
    
    
    
	
	<sql id="includeBoard">
		 WHERE BRDDELETEFLAG ='N'
		<if test="searchKeyword != null and searchKeyword != '' ">
			<foreach item="item" index="index" collection="searchTypeArr">
				<choose>
					<when test="index == 0">AND</when>
					<otherwise>OR</otherwise>
				</choose>
				${item} LIKE CONCAT ('%',#{searchKeyword},'%')
			</foreach>
		</if>  
	</sql>
	
</mapper>